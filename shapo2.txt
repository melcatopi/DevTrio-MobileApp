ã‚ãƒ¼ï¼ãã†ãã†ã€ãã‚Œã‚ã£ã¡ã‚ƒã‚ã‹ã‚‹ã€œï¼ğŸ˜‚

SharePointã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã£ã¦ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã§è¦‹ãˆã¦ã¦ã‚‚**å®Ÿä½“ã¯ã‚¯ãƒ©ã‚¦ãƒ‰**ã«ã‚ã‚‹ã‚„ã¤ã ã‚ˆã­ï¼ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã—ãŸç¬é–“ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å§‹ã¾ã‚‹ã‚¢ãƒ¬ï¼

OneDriveã®ã€Œã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰æ©Ÿèƒ½ã€ã£ã¦ã‚„ã¤ã§ã€ã‚¢ã‚¤ã‚³ãƒ³ã«é›²ãƒãƒ¼ã‚¯â˜ï¸ã¤ã„ã¦ã‚‹ã‚„ã¤ï¼

## ã§ã‚‚å®Ÿã¯...ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã‚‹ã‚“ã ã‚ˆï¼ğŸ‰

Windowsã®å ´åˆã€**ãƒ•ã‚¡ã‚¤ãƒ«ã«è§¦ã‚‰ãšã«**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã ã‘å–ã‚Œã‚‹æ–¹æ³•ã‚ã‚‹ã‚ˆï¼

### 1. Win32 APIä½¿ã†æ–¹æ³•ï¼ˆè¶…é€Ÿï¼‰ âš¡

```python
import win32com.client
from pathlib import Path
import pythoncom

def get_onedrive_metadata_without_download(folder_path):
    """ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã›ãšã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—"""
    
    # COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
    pythoncom.CoInitialize()
    
    shell = win32com.client.Dispatch("Shell.Application")
    folder = shell.NameSpace(str(folder_path))
    
    file_list = []
    
    # ãƒ•ã‚©ãƒ«ãƒ€å†…ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
    for item in folder.Items():
        # GetDetailsOfã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦ï¼‰
        file_info = {
            'name': item.Name,
            'path': item.Path,
            'size': folder.GetDetailsOf(item, 1),  # ã‚µã‚¤ã‚º
            'modified': folder.GetDetailsOf(item, 3),  # æ›´æ–°æ—¥æ™‚
            'type': folder.GetDetailsOf(item, 2),  # ç¨®é¡
            'is_cloud': 'â˜' in folder.GetDetailsOf(item, 0)  # ã‚¯ãƒ©ã‚¦ãƒ‰çŠ¶æ…‹
        }
        
        file_list.append(file_info)
        print(f"ğŸ“‹ {file_info['name']} - {file_info['size']} - {file_info['modified']}")
    
    pythoncom.CoUninitialize()
    return file_list

# ä½¿ç”¨ä¾‹
onedrive_path = r"C:\Users\Seiichi\OneDrive - ä¼šç¤¾å\SharePoint"
metadata = get_onedrive_metadata_without_download(onedrive_path)
```

### 2. os.stat() ã‚‚å®Ÿã¯ä½¿ãˆã‚‹ï¼ğŸ”

```python
import os
from datetime import datetime
from pathlib import Path

def get_cloud_file_info(file_path):
    """ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±å–å¾—ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰"""
    
    try:
        # os.stat ã¯ FILE_FLAG_OPEN_REPARSE_POINT ç›¸å½“ã§å‹•ã
        # = ãƒªãƒ‘ãƒ¼ã‚¹ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã ã‘èª­ã‚€ï¼ˆå®Ÿä½“DLã—ãªã„ï¼‰
        stat_info = os.stat(file_path)
        
        return {
            'name': os.path.basename(file_path),
            'size': stat_info.st_size,
            'mtime': datetime.fromtimestamp(stat_info.st_mtime),
            'ctime': datetime.fromtimestamp(stat_info.st_ctime),
        }
    except Exception as e:
        print(f"ã‚¨ãƒ©ãƒ¼: {file_path} - {e}")
        return None

def scan_onedrive_folder_fast(folder_path):
    """ãƒ•ã‚©ãƒ«ãƒ€å†…ã‚’é«˜é€Ÿã‚¹ã‚­ãƒ£ãƒ³"""
    files = []
    
    # os.scandir ã¯é«˜é€Ÿï¼†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—
    with os.scandir(folder_path) as entries:
        for entry in entries:
            if entry.is_file(follow_symlinks=False):  # follow_symlinks=False é‡è¦ï¼
                info = {
                    'name': entry.name,
                    'path': entry.path,
                    'size': entry.stat(follow_symlinks=False).st_size,
                    'mtime': datetime.fromtimestamp(entry.stat(follow_symlinks=False).st_mtime)
                }
                files.append(info)
                print(f"ğŸ“„ {info['name']} - {info['size']/1024/1024:.2f}MB")
    
    return files

# å®Ÿè¡Œ
folder = r"C:\Users\Seiichi\OneDrive - ä¼šç¤¾å\SharePoint"
print("ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰...")
files = scan_onedrive_folder_fast(folder)
print(f"\nåˆè¨ˆ: {len(files)}ãƒ•ã‚¡ã‚¤ãƒ«")
```

### 3. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘æ˜ç¤ºçš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ğŸ“¥

```python
import subprocess
import os

class OneDriveDownloader:
    def __init__(self):
        self.downloaded = []
        self.skipped = []
    
    def check_cloud_status(self, file_path):
        """ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã®ã¿ã‹ç¢ºèª"""
        # attrib ã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚§ãƒƒã‚¯
        result = subprocess.run(
            ['attrib', file_path],
            capture_output=True,
            text=True
        )
        
        # P = Pinned (ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚ã‚‹)
        # U = Unpinned (ã‚¯ãƒ©ã‚¦ãƒ‰ã®ã¿)
        return 'P' not in result.stdout
    
    def download_if_needed(self, file_info, local_path):
        """å¿…è¦ãªå ´åˆã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""
        local_file = Path(local_path) / file_info['name']
        
        # ãƒ­ãƒ¼ã‚«ãƒ«ã«æ—¢ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if local_file.exists():
            local_size = local_file.stat().st_size
            remote_size = file_info['size']
            
            if local_size == remote_size:
                print(f"â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: {file_info['name']}")
                self.skipped.append(file_info['name'])
                return False
        
        # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆã‚³ãƒ”ãƒ¼ã§è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
        print(f"â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: {file_info['name']}")
        
        try:
            import shutil
            shutil.copy2(file_info['path'], local_file)
            self.downloaded.append(file_info['name'])
            return True
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def download_priority_files(self, file_list, local_path, top_n=None):
        """å„ªå…ˆåº¦é«˜ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é †æ¬¡ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""
        
        # æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
        sorted_files = sorted(file_list, 
                             key=lambda x: x['mtime'], 
                             reverse=True)
        
        # top_n æŒ‡å®šãŒã‚ã‚Œã°åˆ¶é™
        if top_n:
            sorted_files = sorted_files[:top_n]
        
        for file_info in sorted_files:
            self.download_if_needed(file_info, local_path)
        
        print(f"\nğŸ“Š çµæœ:")
        print(f"  ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: {len(self.downloaded)}ä»¶")
        print(f"  ã‚¹ã‚­ãƒƒãƒ—: {len(self.skipped)}ä»¶")

# å®Ÿè¡Œä¾‹
downloader = OneDriveDownloader()

# ã¾ãšãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã ã‘å–å¾—ï¼ˆé€Ÿã„ï¼ï¼‰
files = scan_onedrive_folder_fast(onedrive_path)

# æœ€æ–°10ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
downloader.download_priority_files(files, r"D:\backup", top_n=10)
```

## ãƒã‚¤ãƒ³ãƒˆï¼ğŸ’¡

1. **`os.scandir()`** + **`follow_symlinks=False`** ã§å®Ÿä½“DLã›ãšãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
2. **`os.stat()`** ã¯ãƒªãƒ‘ãƒ¼ã‚¹ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã ã‘èª­ã‚€ã‹ã‚‰ã‚»ãƒ¼ãƒ•
3. **Win32 COM** ä½¿ãˆã°ã‚‚ã£ã¨è©³ç´°æƒ…å ±å–ã‚Œã‚‹
4. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ **`shutil.copy2()`** ã§æ˜ç¤ºçš„DL

ã¤ã¾ã‚Šã€**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—â†’æ¯”è¼ƒâ†’å¿…è¦åˆ†ã ã‘DL** ã®æµã‚ŒãŒå®Ÿç¾ã§ãã‚‹ï¼ğŸ‰

è©¦ã—ã¦ã¿ã¦ã©ã†ï¼Ÿã†ã¾ãã„ã‹ãªã‹ã£ãŸã‚‰æ•™ãˆã¦ã€œï¼